<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <meta name="description" content="Use Viewer to start building new applications or easily embed Cesium into existing applications.">
    <meta name="cesium-sandcastle-labels" content="Beginner, Showcases">
    <title>Cesium Demo</title>
    <script type="text/javascript" src="../Sandcastle-header.js"></script>
    <script src="../CesiumUnminified/Cesium.js"></script>
    <script>window.CESIUM_BASE_URL = "../CesiumUnminified/";</script>
  </head>
  <body
    class="sandcastle-loading"
    data-sandcastle-bucket="bucket-requirejs.html"
  >
<style>
      @import url(../templates/bucket.css);
    </style>
    <div id="cesiumContainer" class="fullSize"></div>
    <div id="loadingOverlay"><h1>Loading...</h1></div>
    <div id="toolbar"></div>
    <script id="cesium_sandcastle_script">
window.startup = async function (Cesium) {
    'use strict';
//Sandcastle_Begin

(async function () {
  const viewer = new Cesium.Viewer("cesiumContainer", {
  // Enable timeline & animation controls
  timeline: true,
  animation: true,
  sceneModePicker: false,
  baseLayerPicker: false,
  geocoder: Cesium.IonGeocodeProviderType.GOOGLE,
  globe: new Cesium.Globe(Cesium.Ellipsoid.WGS84),
});


  viewer.scene.skyAtmosphere.show = true;

  try {
    const tileset = await Cesium.createGooglePhotorealistic3DTileset({
      onlyUsingWithGoogleGeocoder: true,
    });
    viewer.scene.primitives.add(tileset);
  } catch (e) {
    console.error("Error loading Google photorealistic tiles:", e);
  }

  viewer.scene.camera.setView({
    destination: new Cesium.Cartesian3(
      -2693797.551060477,
      -4297135.517094725,
      3854700.7470414364
    ),
    orientation: new Cesium.HeadingPitchRoll(
      4.6550106925119925,
      -0.2863894863138836,
      1.3561760425773173e-7
    ),
  });

  function createModelEntity(url, positionProp) {
    return viewer.entities.add({
      position: positionProp,
      orientation: new Cesium.VelocityOrientationProperty(positionProp),
      model: {
        uri: url,
        minimumPixelSize: 64,
        scale: 1.0,
      },
    });
  }

  // Start drawing path
  const pathPositions = [];
  const dynamicLine = viewer.entities.add({
    polyline: {
      positions: new Cesium.CallbackProperty(() => pathPositions, false),
      width: 4,
      material: Cesium.Color.CYAN,
    },
  });

  const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
  handler.setInputAction((click) => {
    const cart = viewer.scene.pickPosition(click.position);
    if (Cesium.defined(cart)) {
      pathPositions.push(cart);
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

  handler.setInputAction(() => {
    if (pathPositions.length < 2) {
      alert("Draw at least two points with left-click.");
      return;
    }
    handler.destroy();

    // Set up animation along drawn path
    const start = Cesium.JulianDate.now();
    const duration = 20; // seconds
    const end = Cesium.JulianDate.addSeconds(start, duration, new Cesium.JulianDate());
    const sampled = new Cesium.SampledPositionProperty();
    const step = duration / (pathPositions.length - 1);

    pathPositions.forEach((pos, i) => {
      const t = Cesium.JulianDate.addSeconds(start, i * step, new Cesium.JulianDate());
      sampled.addSample(t, pos);
    });

    // Create milk truck and animate
    const truck = createModelEntity(
      "../SampleData/models/CesiumMilkTruck/CesiumMilkTruck.glb",
      sampled
    );
    truck.availability = new Cesium.TimeIntervalCollection([
      new Cesium.TimeInterval({ start, stop: end }),
    ]);
    truck.path = {
      resolution: 1,
      material: new Cesium.PolylineGlowMaterialProperty({
        color: Cesium.Color.YELLOW,
        glowPower: 0.2,
      }),
      width: 6,
    };

    // Configure clock
    viewer.clock.startTime = start.clone();
    viewer.clock.stopTime = end.clone();
    viewer.clock.currentTime = start.clone();
    viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
    viewer.clock.multiplier = 1;
    viewer.timeline.zoomTo(start, end);

    viewer.trackedEntity = truck;
  }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
})();
//Sandcastle_End
    Sandcastle.finishedLoading();
};
if (typeof Cesium !== 'undefined') {
    window.startupCalled = true;
    window.startup(Cesium).catch((error) => {
      "use strict";
      console.error(error);
    });
}
</script>
</body>
</html>
